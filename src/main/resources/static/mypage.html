<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo App - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
    </header>

    <div class="container">
        <div style="text-align: right; margin-bottom: 20px;">
            <span style="color: var(--text-muted); font-size: 0.9rem;">ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <span id="userIdDisplay">---</span></span>
            <button onclick="logout()" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8rem;"
                class="danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div class="card">
            <h2>ãŠé¡Œã‚’æŠ•ç¨¿ã™ã‚‹</h2>
            <p style="color: var(--text-muted); margin-bottom: 15px;">â€»ãƒ“ãƒ³ã‚´ã‚’ä½œã‚‹ã«ã¯å…¨ä½“ã§24å€‹ä»¥ä¸Šã®ãŠé¡ŒãŒã‚ã‚‹ã¨æœ€é©ã§ã™ï¼ˆé‡è¤‡é¿ã‘ï¼‰</p>
            <input type="text" id="topicInput" placeholder="é¢ç™½ã‹ã£ãŸã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã€å¥½ããªé£Ÿã¹ç‰© ãªã©...">
            <input type="number" id="topicAmount" placeholder="é‡‘é¡ï¼ˆæœªå…¥åŠ›ã§0å††ï¼‰"
                style="margin-top: 10px; width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px;">
            <select id="topicDifficulty"
                style="margin-top: 10px; margin-bottom: 10px; width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px;">
                <option value="1">é›£æ˜“åº¦: â˜†1 (è¶…ç°¡å˜)</option>
                <option value="2">é›£æ˜“åº¦: â˜†2 (ç°¡å˜)</option>
                <option value="3" selected>é›£æ˜“åº¦: â˜†3 (æ™®é€š)</option>
                <option value="4">é›£æ˜“åº¦: â˜†4 (é›£ã—ã„)</option>
                <option value="5">é›£æ˜“åº¦: â˜†5 (è¶…é›£ã—ã„)</option>
            </select>
            <button onclick="createTopic()">ãŠé¡Œã‚’æŠ•ç¨¿ï¼</button>
            <div id="topicMsg" style="color: var(--success); margin-top: 10px; font-weight: bold;"></div>
        </div>

        <div class="card">
            <h2>ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚‹</h2>
            <button onclick="generateBingo()"
                style="width: 100%; font-size: 1.2rem; padding: 15px;">æ–°ã—ã„ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹</button>
            <div id="bingoLinkArea"
                style="margin-top: 20px; display: none; text-align: center; padding: 15px; border: 2px dashed var(--primary); border-radius: 8px;">
                <p>ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ãŒå®Œæˆã—ã¾ã—ãŸï¼</p>
                <a id="bingoLink" href="#"
                    style="color: var(--primary); font-size: 1.2rem; font-weight: bold; text-decoration: none;">ğŸ‘‰
                    ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’é–‹ã</a>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>è‡ªåˆ†ã®ä½œæˆã—ãŸãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰</h2>
            <div id="myBingoCardsArea">
                <p style="text-align: center; color: var(--text-muted);">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>è‡ªåˆ†ã®æŠ•ç¨¿ã—ãŸãŠé¡Œä¸€è¦§ <span id="myTopicsTotalAmount" style="font-size: 1rem; color: var(--text-muted);"></span>
            </h2>
            <div id="myTopicsArea">
                <p style="text-align: center; color: var(--text-muted);">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <nav>
            <a href="admin.html">å…¨ãŠé¡Œã‚’è¦‹ã‚‹ï¼ˆç®¡ç†è€…ç”¨ï¼‰</a>
        </nav>
    </div>

    <script>
        let userId = localStorage.getItem('bingoUserId');

        window.onload = () => {
            if (!userId) {
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('userIdDisplay').innerText = userId;
            fetchMyTopics();
            fetchMyBingoCards();
        };

        async function fetchMyBingoCards() {
            const area = document.getElementById('myBingoCardsArea');
            try {
                const res = await fetch(`/api/bingo/user/${userId}`);
                if (!res.ok) throw new Error('API Error');
                const cards = await res.json();

                if (cards.length === 0) {
                    area.innerHTML = '<p style="text-align: center; color: var(--text-muted);">ã¾ã ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã„ã¾ã›ã‚“ã€‚</p>';
                    return;
                }

                area.innerHTML = '';
                cards.forEach((card, index) => {
                    const div = document.createElement('div');
                    div.style.padding = '10px';
                    div.style.borderBottom = '1px solid var(--border)';
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';

                    const textSpan = document.createElement('span');
                    textSpan.style.flex = '1';
                    textSpan.innerText = `ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ #${index + 1}`;

                    const actionDiv = document.createElement('div');

                    const openBtn = document.createElement('button');
                    openBtn.innerText = 'é–‹ã';
                    openBtn.style.padding = '5px 10px';
                    openBtn.style.fontSize = '0.8rem';
                    openBtn.onclick = () => {
                        window.location.href = `bingo.html?id=${card.id}`;
                    };

                    actionDiv.appendChild(openBtn);
                    div.appendChild(textSpan);
                    div.appendChild(actionDiv);
                    area.appendChild(div);
                });
            } catch (e) {
                area.innerHTML = '<p style="text-align: center; color: var(--danger);">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
                console.error(e);
            }
        }

        function logout() {
            localStorage.removeItem('bingoUserId');
            window.location.href = 'index.html';
        }

        async function createTopic() {
            const content = document.getElementById('topicInput').value.trim();
            if (!content) return;
            const amountInput = document.getElementById('topicAmount').value;
            const amount = amountInput ? parseInt(amountInput, 10) : 0;
            const difficultyInput = document.getElementById('topicDifficulty').value;
            const difficulty = parseInt(difficultyInput, 10);

            const res = await fetch('/api/topics', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content, amount: amount, difficulty: difficulty, creatorId: userId })
            });

            if (res.ok) {
                document.getElementById('topicInput').value = '';
                document.getElementById('topicAmount').value = '';
                document.getElementById('topicDifficulty').value = '3';
                const msg = document.getElementById('topicMsg');
                msg.innerText = "ã€Œ" + content + "ï¼ˆâ˜†" + difficulty + " / " + amount + "å††ï¼‰ã€ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼âœ¨";
                setTimeout(() => msg.innerText = '', 3000);
                fetchMyTopics(); // Refresh list
            } else {
                alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        async function fetchMyTopics() {
            const area = document.getElementById('myTopicsArea');
            try {
                const res = await fetch(`/api/topics/user/${userId}`);
                if (!res.ok) throw new Error('API Error');
                const topics = await res.json();

                const totalSpan = document.getElementById('myTopicsTotalAmount');
                if (totalSpan) {
                    const totalAmount = topics.reduce((sum, topic) => sum + (topic.amount || 0), 0);
                    totalSpan.innerText = `ï¼ˆåˆè¨ˆé‡‘é¡: ${totalAmount}å††ï¼‰`;
                }

                if (topics.length === 0) {
                    area.innerHTML = '<p style="text-align: center; color: var(--text-muted);">ã¾ã ãŠé¡Œã‚’æŠ•ç¨¿ã—ã¦ã„ã¾ã›ã‚“ã€‚</p>';
                    return;
                }

                area.innerHTML = '';
                topics.forEach(topic => {
                    const div = document.createElement('div');
                    div.style.padding = '10px';
                    div.style.borderBottom = '1px solid var(--border)';
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';

                    const textSpan = document.createElement('span');
                    textSpan.style.flex = '1';
                    const diffStars = topic.difficulty ? `â˜†${topic.difficulty}` : `â˜†3`;
                    textSpan.innerText = `${topic.content}ï¼ˆ${diffStars} / ${topic.amount}å††ï¼‰`;

                    const actionDiv = document.createElement('div');

                    const editBtn = document.createElement('button');
                    editBtn.innerText = 'ç·¨é›†';
                    editBtn.style.padding = '5px 10px';
                    editBtn.style.fontSize = '0.8rem';
                    editBtn.style.marginRight = '5px';
                    editBtn.onclick = () => showEditInline(div, topic.id, topic.content, topic.amount, topic.difficulty);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerText = 'å‰Šé™¤';
                    deleteBtn.className = 'danger';
                    deleteBtn.style.padding = '5px 10px';
                    deleteBtn.style.fontSize = '0.8rem';
                    deleteBtn.onclick = () => deleteTopic(topic.id, topic.content);

                    actionDiv.appendChild(editBtn);
                    actionDiv.appendChild(deleteBtn);

                    div.appendChild(textSpan);
                    div.appendChild(actionDiv);
                    area.appendChild(div);
                });
            } catch (e) {
                area.innerHTML = '<p style="text-align: center; color: var(--danger);">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
                console.error(e);
            }
        }

        function showEditInline(div, topicId, currentContent, currentAmount, currentDifficulty) {
            div.innerHTML = '';

            const editForm = document.createElement('div');
            editForm.style.display = 'flex';
            editForm.style.flexDirection = 'column';
            editForm.style.width = '100%';
            editForm.style.gap = '5px';

            const contentInput = document.createElement('input');
            contentInput.type = 'text';
            contentInput.value = currentContent;
            contentInput.style.padding = '5px';
            contentInput.style.border = '1px solid var(--border)';
            contentInput.style.borderRadius = '4px';

            const amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.placeholder = 'é‡‘é¡ï¼ˆæœªå…¥åŠ›ã§0å††ï¼‰';
            if (currentAmount !== undefined) amountInput.value = currentAmount;
            amountInput.style.padding = '5px';
            amountInput.style.border = '1px solid var(--border)';
            amountInput.style.borderRadius = '4px';

            const difficultySelect = document.createElement('select');
            difficultySelect.style.padding = '5px';
            difficultySelect.style.border = '1px solid var(--border)';
            difficultySelect.style.borderRadius = '4px';
            for (let i = 1; i <= 5; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `â˜†${i}`;
                if (currentDifficulty === i || (currentDifficulty === undefined && i === 3)) {
                    opt.selected = true;
                }
                difficultySelect.appendChild(opt);
            }

            const actionDiv = document.createElement('div');
            actionDiv.style.display = 'flex';
            actionDiv.style.gap = '5px';
            actionDiv.style.justifyContent = 'flex-end';

            const saveBtn = document.createElement('button');
            saveBtn.innerText = 'ä¿å­˜';
            saveBtn.style.padding = '5px 10px';
            saveBtn.style.fontSize = '0.8rem';
            saveBtn.onclick = () => saveEdit(topicId, contentInput.value, amountInput.value, difficultySelect.value);

            const cancelBtn = document.createElement('button');
            cancelBtn.innerText = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
            cancelBtn.className = 'danger';
            cancelBtn.style.padding = '5px 10px';
            cancelBtn.style.fontSize = '0.8rem';
            cancelBtn.onclick = () => fetchMyTopics(); // just reload

            actionDiv.appendChild(saveBtn);
            actionDiv.appendChild(cancelBtn);

            editForm.appendChild(contentInput);
            editForm.appendChild(amountInput);
            editForm.appendChild(difficultySelect);
            editForm.appendChild(actionDiv);

            div.appendChild(editForm);
        }

        async function saveEdit(topicId, newContent, newAmountStr, newDifficultyStr) {
            if (!newContent || newContent.trim() === '') return;
            const newAmount = parseInt(newAmountStr, 10) || 0;
            const newDifficulty = parseInt(newDifficultyStr, 10) || 3;

            try {
                const res = await fetch(`/api/topics/${topicId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: newContent.trim(), amount: newAmount, difficulty: newDifficulty, creatorId: userId })
                });

                if (res.ok) {
                    fetchMyTopics();
                } else {
                    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            } catch (e) {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }

        async function deleteTopic(topicId, currentContent) {
            if (!confirm(`ã€Œ${currentContent}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

            try {
                const res = await fetch(`/api/topics/${topicId}?userId=${userId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    fetchMyTopics();
                } else {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            } catch (e) {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }

        async function generateBingo() {
            try {
                const res = await fetch(`/api/bingo/generate?userId=${userId}`, { method: 'POST' });
                if (res.ok) {
                    const card = await res.json();
                    const linkArea = document.getElementById('bingoLinkArea');
                    const link = document.getElementById('bingoLink');

                    link.href = `bingo.html?id=${card.id}`;
                    linkArea.style.display = 'block';
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                } else {
                    alert('ã‚«ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ï¼ˆãŠé¡ŒãŒå…¨ãç™»éŒ²ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰');
                }
            } catch (e) {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }
    </script>
</body>

</html>