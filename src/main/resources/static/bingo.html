<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo App - ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .bingo-board-wrapper {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
    </style>
</head>

<body>
    <header>
        <h1>Let's BINGO!</h1>
    </header>

    <div class="container bingo-board-wrapper">
        <div class="card" id="cardContainer">
            <h2 style="text-align: center;">ã‚ãªãŸã®ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰</h2>
            <div id="scoreDisplay"
                style="text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                å¾—ç‚¹: 0ç‚¹
            </div>
            <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px;">
                ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç©´ã‚’ã‚ã‘ã‚‰ã‚Œã¾ã™ã€‚<br>
                ä¿å­˜ã‚’å¿˜ã‚Œãšã«å…±æœ‰ã—ã¦ãã ã•ã„ï¼
            </p>
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="copyShareLink()" style="background-color: var(--secondary); font-size: 0.9rem;">ğŸ”—
                    å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>

            <div id="bingoGrid" class="bingo-board">
                <!-- Grid will be generated here -->
            </div>

            <div id="errorMessage" style="color: var(--danger); text-align: center; display: none; margin-top: 20px;">
            </div>
        </div>

        <nav>
            <a href="mypage.html">ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        </nav>
    </div>

    <!-- Custom Modal -->
    <div id="topicModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="modalTopicTitle" style="margin-top: 0;"></h2>
            <div id="modalTopicDescription"
                style="margin-bottom: 20px; color: var(--text-muted); min-height: 40px; font-size: 0.95rem;">
                èª­ã¿è¾¼ã¿ä¸­...
            </div>
            <div id="modalActionButtons" class="modal-actions">
                <button id="modalPunchBtn">ç©´ã‚’ã‚ã‘ã‚‹</button>
                <button id="modalCloseBtn" style="background-color: var(--secondary);">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let stompClient = null;

        window.onload = () => {
            if (!cardId) {
                showError('URLã«ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®IDãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            fetchCardData();
            connectWebSocket();
        };

        function connectWebSocket() {
            const socket = new SockJS('/ws-bingo');
            stompClient = new window.StompJs.Client({
                webSocketFactory: () => socket,
                debug: function (str) {
                    console.log(str);
                },
                onConnect: function (frame) {
                    console.log('Connected: ' + frame);
                    stompClient.subscribe('/topic/bingo/' + cardId, function (message) {
                        const updatedCard = JSON.parse(message.body);
                        renderBingoGrid(updatedCard);
                    });
                },
                onStompError: function (frame) {
                    console.error('Broker reported error: ' + frame.headers['message']);
                    console.error('Additional details: ' + frame.body);
                }
            });
            stompClient.activate();
        }

        function copyShareLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n' + url);
            }).catch(err => {
                console.error('ãƒªãƒ³ã‚¯ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                alert('ãƒªãƒ³ã‚¯ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }

        async function fetchCardData() {
            try {
                const res = await fetch(`/api/bingo/${cardId}`);
                if (res.ok) {
                    const card = await res.json();
                    renderBingoGrid(card);
                } else {
                    showError('ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å­˜åœ¨ã—ãªã„ã‹URLãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
                }
            } catch (e) {
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function renderBingoGrid(card) {
            const grid = document.getElementById('bingoGrid');
            grid.innerHTML = '';

            const topics = card.topics.split(',');
            const punches = card.punchStatus.split(',').map(s => s === 'true');

            // Calculate score
            const { score, linesCount } = calculateScore(punches);
            document.getElementById('scoreDisplay').innerText = `å¾—ç‚¹: ${score}ç‚¹ (ãƒã‚¹: ${punches.filter((p, i) => p && i !== 12).length}ç‚¹, ãƒ©ã‚¤ãƒ³: ${linesCount}æœ¬ x 3ç‚¹)`;

            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.className = 'bingo-cell';

                // Set FREE space or normal topics
                if (i === 12) {
                    cell.innerText = 'FREE';
                    cell.classList.add('free');
                } else {
                    cell.innerText = topics[i];
                    if (punches[i]) {
                        cell.classList.add('punched');
                    }

                    // Click handler
                    cell.onclick = () => togglePunch(i, punches[i], topics[i]);
                }

                grid.appendChild(cell);
            }
        }

        function calculateScore(punches) {
            let score = 0;
            let squarePoints = 0;
            punches.forEach((p, index) => {
                if (p && index !== 12) squarePoints += 1; // index 12 is FREE space (0 points)
            });
            score += squarePoints;

            const lines = [
                // Rows
                [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24],
                // Columns
                [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24],
                // Diagonals
                [0, 6, 12, 18, 24], [4, 8, 12, 16, 20]
            ];

            let linesCount = 0;
            lines.forEach(line => {
                if (line.every(index => punches[index])) {
                    linesCount++;
                }
            });
            score += linesCount * 3;

            return { score, linesCount };
        }

        async function togglePunch(index, currentStatus, content) {
            if (index === 12) return; // Ignore FREE space clicks entirely

            const modal = document.getElementById('topicModal');
            const titleEl = document.getElementById('modalTopicTitle');
            const descEl = document.getElementById('modalTopicDescription');
            const punchBtn = document.getElementById('modalPunchBtn');
            const closeBtn = document.getElementById('modalCloseBtn');

            titleEl.innerText = content;
            descEl.innerText = 'èª­ã¿è¾¼ã¿ä¸­...';

            if (currentStatus) {
                punchBtn.innerText = 'ç©´ã‚’å…ƒã«æˆ»ã™';
                punchBtn.className = 'danger';
            } else {
                punchBtn.innerText = 'ç©´ã‚’ã‚ã‘ã‚‹';
                punchBtn.className = '';
            }

            modal.style.display = 'flex';

            try {
                const searchRes = await fetch(`/api/topics/search?content=${encodeURIComponent(content)}`);
                if (searchRes.ok) {
                    const topicData = await searchRes.json();
                    if (topicData.description) {
                        descEl.innerText = topicData.description;
                    } else {
                        descEl.innerText = 'ï¼ˆèª¬æ˜ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰';
                    }
                } else {
                    descEl.innerText = 'ï¼ˆèª¬æ˜ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰';
                }
            } catch (err) {
                descEl.innerText = 'ï¼ˆèª¬æ˜ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰';
            }

            // Cleanup old listeners
            const newPunchBtn = punchBtn.cloneNode(true);
            punchBtn.parentNode.replaceChild(newPunchBtn, punchBtn);
            const newCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

            newCloseBtn.onclick = () => {
                modal.style.display = 'none';
            };

            newPunchBtn.onclick = async () => {
                modal.style.display = 'none';
                try {
                    const res = await fetch(`/api/bingo/${cardId}/punch`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ index: index, status: !currentStatus })
                    });

                    if (res.ok) {
                        const updatedCard = await res.json();
                        renderBingoGrid(updatedCard);
                    } else {
                        alert('çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                } catch (e) {
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§çŠ¶æ…‹ã‚’æ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            };
        }

        function showError(msg) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerText = msg;
            errorDiv.style.display = 'block';
            document.getElementById('bingoGrid').style.display = 'none';
        }
    </script>
</body>

</html>